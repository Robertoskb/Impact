<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Skills Cancelled Fix</title>
</head>
<body>
    <h1>Teste: Tratamento de Quest√µes Anuladas</h1>
    <div id="output"></div>
    
    <script>
        // Teste para verificar se quest√µes anuladas s√£o corretamente ignoradas
        // no relat√≥rio de habilidades (n√£o tentam buscar habilidade no meta.json)
        console.log('üß™ TESTE: Verificando tratamento de quest√µes anuladas no SkillsReportCalculator\n');

        // Simular cen√°rio real do ENEM 2022 - Matem√°tica
        // Onde existem 2 quest√µes anuladas que N√ÉO est√£o no meta.json
        const testData = {
          questions: [
            // Quest√µes v√°lidas que est√£o no meta.json
            { position: 171, area: 'MT', cancelled: false },
            { position: 173, area: 'MT', cancelled: false },
            { position: 175, area: 'MT', cancelled: false },
            
            // Quest√µes anuladas que N√ÉO est√£o no meta.json 
            // (estas eram as que causavam o problema)
            { position: 162, area: 'MT', cancelled: true },  // ANULADA
            { position: 178, area: 'MT', cancelled: true },  // ANULADA
          ],
          
          answers: {
            171: 'E',  // Respondida
            173: 'D',  // Respondida  
            175: 'E',  // Respondida
            162: 'A',  // Anulada mas respondida (deve ser ignorada)
            178: 'B',  // Anulada mas respondida (deve ser ignorada)
          },
          
          // Meta.json real para 2022 MT (posi√ß√µes que existem)
          meta: {
            2022: {
              MT: {
                // Quest√µes v√°lidas com habilidades conhecidas
                171: { hability: 29, answer: 'E' },
                173: { hability: 25, answer: 'D' },
                175: { hability: 1, answer: 'E' },
                // Quest√µes 162 e 178 N√ÉO est√£o aqui (por isso s√£o anuladas)
              }
            }
          }
        };

        // Simular processamento do SkillsReportCalculator
        function testSkillsReportCalculator() {
          console.log('üéØ TESTE: SkillsReportCalculator com quest√µes anuladas\n');
          
          const skillsData = {};
          
          testData.questions.forEach(question => {
            const area = question.area;
            
            // NOVA L√ìGICA: Pular quest√µes anuladas
            if (question.cancelled) {
              console.log(`‚è≠Ô∏è Quest√£o ${question.position} (${area}) pulada - quest√£o anulada (sem habilidade conhecida)`);
              return;
            }
            
            // Verificar se existe metadados para esta quest√£o
            if (!testData.meta[2022][area] || !testData.meta[2022][area][question.position]) {
              console.warn(`Metadados n√£o encontrados para quest√£o ${question.position} (${area})`);
              return;
            }
            
            const questionMeta = testData.meta[2022][area][question.position];
            const hability = questionMeta.hability;
            
            if (!hability) {
              console.warn(`Habilidade n√£o encontrada para quest√£o ${question.position} (${area})`);
              return;
            }
            
            console.log(`üìö Quest√£o ${question.position} (${area}) ‚Üí H${hability}`);
            
            // Inicializar √°rea se n√£o existir
            if (!skillsData[area]) {
              skillsData[area] = {};
            }
            
            // Inicializar habilidade se n√£o existir
            if (!skillsData[area][hability]) {
              skillsData[area][hability] = {
                total: 0,
                correct: 0,
                wrong: 0,
                cancelled: 0,
                questions: []
              };
            }
            
            const skillData = skillsData[area][hability];
            skillData.total++;
            skillData.questions.push(question);
            
            // Como quest√µes anuladas foram filtradas, todas aqui s√£o v√°lidas
            const correctAnswer = questionMeta.answer;
            const userAnswer = testData.answers[question.position];
            
            if (userAnswer && userAnswer === correctAnswer) {
              skillData.correct++;
            } else if (userAnswer) {
              skillData.wrong++;
            }
          });
          
          // Processar resultados
          console.log('\nüìä RESULTADOS POR HABILIDADE:');
          Object.keys(skillsData).forEach(area => {
            Object.keys(skillsData[area]).forEach(hability => {
              const skillData = skillsData[area][hability];
              const percentage = skillData.total > 0 
                ? Math.round((skillData.correct / skillData.total) * 100) 
                : 0;
              
              console.log(`   H${hability}: ${skillData.correct}/${skillData.total} = ${percentage}%`);
              console.log(`     Quest√µes: [${skillData.questions.map(q => q.position).join(', ')}]`);
            });
          });
          
          console.log('\n‚úÖ TESTE PASSOU: Quest√µes anuladas foram ignoradas corretamente');
          console.log('‚úÖ N√£o houve tentativa de buscar habilidade para quest√µes anuladas');
          console.log('‚úÖ Apenas quest√µes v√°lidas foram processadas no relat√≥rio');
        }

        // Executar teste
        testSkillsReportCalculator();

        console.log('\nüéâ RESUMO DA CORRE√á√ÉO:');
        console.log('- Quest√µes anuladas s√£o filtradas ANTES de tentar buscar habilidades');
        console.log('- Evita erro de tentar buscar habilidade de quest√µes que n√£o est√£o no meta.json');
        console.log('- Relat√≥rio de habilidades fica mais preciso e confi√°vel');
    </script>
</body>
</html>
